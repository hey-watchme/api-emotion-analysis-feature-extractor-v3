name: Deploy to ECR

on:
  push:
    branches:
      - main

env:
  AWS_REGION: ap-southeast-2
  ECR_REPOSITORY: watchme-emotion-analysis-hume
  EC2_HOST: 3.24.16.82
  EC2_USER: ubuntu
  SERVICE_NAME: emotion-analysis-hume
  SERVICE_PORT: 8019

  # Secrets from GitHub
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}

  # Hume API
  HUME_API_KEY: ${{ secrets.HUME_API_KEY }}
  HUME_SECRET_KEY: ${{ secrets.HUME_SECRET_KEY }}

  # Supabase
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

  # SQS
  FEATURE_COMPLETED_QUEUE_URL: ${{ secrets.FEATURE_COMPLETED_QUEUE_URL }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build and push Docker image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
        echo "Image pushed to $ECR_REGISTRY/$ECR_REPOSITORY:latest"

    - name: Deploy to EC2
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
      run: |
        # Setup SSH
        echo "${{ secrets.EC2_SSH_KEY }}" > ec2_key.pem
        chmod 600 ec2_key.pem

        # Create deployment directory on EC2
        ssh -o StrictHostKeyChecking=no -i ec2_key.pem ${EC2_USER}@${EC2_HOST} << 'ENDSSH'
          mkdir -p /home/ubuntu/${SERVICE_NAME}
        ENDSSH

        # Copy docker-compose file
        scp -o StrictHostKeyChecking=no -i ec2_key.pem \
          docker-compose.prod.yml \
          ${EC2_USER}@${EC2_HOST}:/home/ubuntu/${SERVICE_NAME}/docker-compose.yml

        # Create .env file and deploy
        ssh -o StrictHostKeyChecking=no -i ec2_key.pem ${EC2_USER}@${EC2_HOST} << ENDSSH
          cd /home/ubuntu/${SERVICE_NAME}

          # Create .env file with secrets
          cat > .env << 'EOF'
HUME_API_KEY=${HUME_API_KEY}
HUME_SECRET_KEY=${HUME_SECRET_KEY}
AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
AWS_REGION=${AWS_REGION}
S3_BUCKET_NAME=watchme-vault
SUPABASE_URL=${SUPABASE_URL}
SUPABASE_KEY=${SUPABASE_KEY}
FEATURE_COMPLETED_QUEUE_URL=${FEATURE_COMPLETED_QUEUE_URL}
HUME_POLL_INTERVAL=3
HUME_MAX_POLL_ATTEMPTS=40
HUME_CONFIDENCE_THRESHOLD=0.5
EOF

          # Login to ECR from EC2
          aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}

          # Stop existing container
          docker-compose down || true

          # Pull latest image
          docker pull ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest

          # Start new container
          docker-compose up -d

          # Check if container is running
          sleep 10
          docker ps | grep ${SERVICE_NAME}

          # Check health endpoint
          curl -f http://localhost:${SERVICE_PORT}/health || exit 1

          echo "Deployment successful!"
        ENDSSH

        # Cleanup
        rm -f ec2_key.pem

    - name: Verify deployment
      run: |
        sleep 5
        echo "Checking service health..."
        curl -f https://api.hey-watch.me/emotion-analysis/hume/health || echo "Warning: Health check failed. Please check manually."